models:
  - name: stg_klt__kobo_asset
    description: Kobo 'asset' or 'project'
    columns:
      - name: asset_id
        description: Unique asset identifier from Kobo (one row per asset)
        data_tests:
          - unique
          - not_null
      - name: asset_load_id
        description: DLT load identifier
      - name: created_at
        description: Creation time (UTC)
      - name: modified_at
        description: Modified time (UTC)
      - name: deployed_at
        description: Deployment time (UTC)
      - name: loaded_at
        description: Loaded time (UTC)
      - name: last_submission_at
        description: Timestamp of last submission (UTC); assets without submissions are filtered upstream
        data_tests:
          - not_null
      - name: asset_name
        description: Asset display name
      - name: deployment_active
        description: Deployment activated flag
      - name: count_submissions
        description: Total submissions recorded
  - name: stg_klt__kobo_asset_content__survey
    description: Form survey questions
    columns:
      - name: asset_id
        description: Foreign key to stg_klt__kobo_asset
      - name: asset_load_id
        description: DLT load identifier
      - name: loaded_at
        description: Loaded time (UTC)
      - name: xpath
        description: XPath location of question in form structure
      - name: question_name
        description: Question identifier/name
  - name: stg_klt__kobo_submission
    description: Kobo submission
    columns:
      - name: asset_id
        description: Foreign key to stg_klt__kobo_asset_stats
        data_tests:
          - relationships:
              to: ref('stg_klt__kobo_asset_stats')
              field: asset_id
      - name: submission_id
        description: Unique submission identifier
        data_tests:
          - unique
          - not_null
      - name: submission_load_id
        description: DLT load identifier for submission
        data_tests:
          - not_null
      - name: loaded_at
        description: Loaded time (UTC)
        data_tests:
          - not_null
      - name: submitted_at
        description: Submission time (UTC)
  - name: stg_klt__kobo_asset_stats
    description: Kobo asset submission statistics
    columns:
      - name: asset_id
        description: Asset identifier matching submission records
        data_tests:
          - relationships:
              to: ref('stg_klt__kobo_submission')
              field: asset_id
      - name: asset_load_id
        description: DLT load identifier
      - name: loaded_at
        description: Loaded time (UTC)
      - name: last_submission_at
        description: Timestamp of last submission (UTC)
      - name: count_submissions
        description: Total submissions recorded
  - name: stg_klt__kobo_audit_log__submission_management
    description: Kobo Server Audit Logs
    columns:
      - name: loaded_at
        description: Loaded time (UTC)
        data_tests:
          - not_null
      - name: audit_load_id
        data_tests:
          - not_null
          - unique
      - name: created_at
        description: Audit Entry Creation Time (UTC)
        data_tests:
          - not_null
      - name: user_id
        data_tests:
          - not_null
      - name: user_name
        data_tests:
          - not_null
      - name: action
        data_tests:
          - not_null
      - name: asset_id
        data_tests:
          - not_null
      - name: submission_uuid
        data_tests:
          - not_null

data_tests:
  - name: assert_stg_klt__kobo_asset_stats_count_matches_submissions
    description: >
      Compares computed submission counts from `stg_klt__kobo_submission` to observed counts in
      `stg_klt__kobo_asset_stats` using a left join on `asset_id`. The test fails when
      `observed_count_submissions` is null, or when `computed_count_submissions` is strictly smaller than
      `observed_count_submissions` for assets whose oldest submission is within the last year. This test is
      intentionally focused on undercounting and does not evaluate assets present only in observed stats.
